#
# spec file for package rtems
# 
# Copyright  (c)  1999  OARCorp, Huntsville, AL
#
# please send bugfixes or comments to joel@OARcorp.com
#

Vendor:       OAR Corporation
Distribution: Linux
Name:         rtems-@target_alias@-@bsp@
Release:      @Release@
License:      GPL with special exception for linking with application program
Group:        unsorted
Provides:     rtems-@target_alias@-@bsp@

Autoreqprov:  on
Packager:     	corsepiu@faw.uni-ulm.de and joel@OARcorp.com
Requires:     	@target_alias@-binutils
Requires:     	@target_alias@-gcc 

Version:      @rtems_version@
Summary:      A free operating system for embedded systems
Source:       rtems-@rtems_version@.tar.gz
#
# The original sources are not included in the source RPM.
# If we included them, then the source RPMs for each target
# would duplicate MBs of source unnecessarily.  This is 
# a duplication of over 30 MBs of source for each of
# the more than 10 targets it is possible to build.
#
# You can get them yourself from the Internet and copy them to
# your /usr/src/redhat/SOURCES directory ($RPM_SOURCE_DIR).
# Or you can try the ftp options of rpm :-)
#
NoSource:      0
# We claim to be relocatible, but in fact we are not
Prefix:	      /opt
Buildroot:    @rpm_build_root@

%description
RTEMS is a free operating system for embedded systems.

Authors:
--------
    Joel Sherrill (joel@oarcorp.com)
    ...

%prep
# untar the sources inside rtems-@target_alias@-@bsp@-@rtems_version@
%setup -c -n rtems-@target_alias@-@bsp@-@rtems_version@
# no patch needed
# %patch
%build
# rtems does not support building inside the source tree
  if test ! -f rtems-@rtems_version@/configure;
  then
  ( cd rtems-@rtems_version@; ./bootstrap )
  fi  
  ./rtems-@rtems_version@/configure \
  --target=@target_alias@ \
  --prefix=/opt/rtems/@target_alias@ \
  --enable-networking \
  --enable-posix \
  --enable-cxx \
  --disable-tests \
  --enable-rdbg \
  --disable-multiprocessing \
  --disable-itron 
  make RTEMS_BSP=@bsp@ 
%install
  make RTEMS_BSP=@bsp@ prefix=$RPM_BUILD_ROOT/opt/rtems/@target_alias@ install
  find $RPM_BUILD_ROOT/opt/rtems/@target_alias@/@bsp@ -type d | \
    sed "s,^$RPM_BUILD_ROOT,%dir ,g" > files
  find $RPM_BUILD_ROOT/opt/rtems/@target_alias@/@bsp@ -type f | \
    sed "s,^$RPM_BUILD_ROOT,,g" >> files
  find $RPM_BUILD_ROOT/opt/rtems/@target_alias@/make -type d | \
    sed "s,^$RPM_BUILD_ROOT,%dir ,g" >> files
  find $RPM_BUILD_ROOT/opt/rtems/@target_alias@/make -type f | \
    sed "s,^$RPM_BUILD_ROOT,,g" >> files

%post
  if test "$RPM_INSTALL_PREFIX" != "/opt/";
  then
    if test -f $RPM_INSTALL_PREFIX/rtems/@target_alias@/make/target.cfg; 
    then
    sed -e 's,/opt/rtems/,$RPM_INSTALL_PREFIX/rtems,g' \
      < $RPM_INSTALL_PREFIX/rtems/@target_alias@/make/target.cfg \
      > $RPM_INSTALL_PREFIX/rtems/@target_alias@/make/target.cfg~
    mv $RPM_INSTALL_PREFIX/rtems/@target_alias@/make/target.cfg~ \
      $RPM_INSTALL_PREFIX/rtems/@target_alias@/make/target.cfg
    fi
  fi

%files -f files
